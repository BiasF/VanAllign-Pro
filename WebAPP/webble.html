<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VanAlign Pro 1.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      else directionText += 'Auto steht gerade (vorne/hinten)';
      document.getElementById('tilt').textContent = directionText + `\nLinks/Rechts: ${Math.round(rollLabel)}°\nVorne/Hinten: ${Math.round(pitchLabel)}°`;
      document.getElementById('lr_val').textContent = `${Math.round(rollLabel)}°`;
      document.getElementById('vh_val').textContent = `${Math.round(pitchLabel)}°`;
      drawCarLR(rollLabel);
      drawCarVH(pitchLabel);
      let lrDir = '';
      if (rollLabel > 2) lrDir = 'Auto neigt nach rechts';
      else if (rollLabel < -2) lrDir = 'Auto neigt nach links';
      else lrDir = 'Auto steht gerade';
      document.getElementById('tilt_lr').textContent = lrDir;
      let vhDir = '';
      if (pitchLabel > 2) vhDir = 'Auto neigt nach vorne';
      else if (pitchLabel < -2) vhDir = 'Auto neigt nach hinten';
      else vhDir = 'Auto steht gerade';
      document.getElementById('tilt_vh').textContent = vhDir;
    } else {
      document.getElementById('tilt').textContent =
        `Pitch: ${Math.round(pitchLabel)}°\nRoll: ${Math.round(rollLabel)}°`;
      document.getElementById('lr_val').textContent = `${Math.round(rollLabel)}°`;
      document.getElementById('vh_val').textContent = `${Math.round(pitchLabel)}°`;
      drawCarLR(rollLabel);
      drawCarVH(pitchLabel);
      document.getElementById('tilt_lr').textContent = '';
      document.getElementById('tilt_vh').textContent = '';
    }
    drawLevel(x, y);
    document.getElementById('output').textContent = '';
  });
};
</script>
   
  </div>
  <script>
    function drawLevel(x, y) {
      const canvas = document.getElementById('levelCanvas');
      // Responsive Canvas
      let size = Math.min(canvas.parentElement.offsetWidth, 300);
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Großer Kreis (Wasserwaage-Rahmen)
      ctx.beginPath();
      ctx.arc(size/2, size/2, size/2-10, 0, 2 * Math.PI);
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 4;
      ctx.stroke();
      // Skala
      ctx.font = `${Math.round(size/18)}px Arial`;
      ctx.fillStyle = '#333';
      ctx.fillText('-30°', 10, size/2);
      ctx.fillText('+30°', size-50, size/2);
      ctx.fillText('0°', size/2-10, size-10);
      // Kleiner Kreis (Mitte)
      ctx.beginPath();
      ctx.arc(size/2, size/2, size/20, 0, 2 * Math.PI);
      ctx.fillStyle = '#bbb';
      ctx.fill();
      ctx.strokeStyle = '#888';
      ctx.lineWidth = 2;
      ctx.stroke();
      // Bubble
      x = Math.max(-30, Math.min(30, x));
      y = Math.max(-30, Math.min(30, y));
      // Bubble-Position berechnen (x/y: -30 bis +30 mapped auf -(size/2-30) bis +(size/2-30))
      const bubbleX = size/2 + (x * (size/2-30) / 30);
      const bubbleY = size/2 + (y * (size/2-30) / 30);
      ctx.beginPath();
      ctx.arc(bubbleX, bubbleY, size/12, 0, 2 * Math.PI);
      ctx.fillStyle = '#4fc3f7';
      ctx.fill();
      ctx.strokeStyle = '#1976d2';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
    document.getElementById('connect').onclick = async () => {
      let pitchChar, rollChar;
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['2a24b789-7aab-4535-af3e-ee76a35cc42d'] }],
          optionalServices: ['2a24b789-7aab-4535-af3e-ee76a35cc42d']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('2a24b789-7aab-4535-af3e-ee76a35cc42d');
        pitchChar = await service.getCharacteristic('cad48e28-7fbe-41cf-bae9-d77a6c233424');
        rollChar  = await service.getCharacteristic('cad48e28-7fbe-41cf-bae9-d77a6c233425');
        let lastPitch = null, lastRoll = null;
        setInterval(async () => {
          try {
            const pitchVal = await pitchChar.readValue();
            const rollVal  = await rollChar.readValue();
            function decodeFloat(val) {
              if (val.byteLength !== 4) return null;
              let fLE = val.getFloat32(0, true);
              let fBE = val.getFloat32(0, false);
              if (!isNaN(fLE) && Math.abs(fLE) < 1000) return fLE;
              if (!isNaN(fBE) && Math.abs(fBE) < 1000) return fBE;
              return null;
            }
            let pitch = decodeFloat(pitchVal);
            let roll  = decodeFloat(rollVal);
            if (pitch !== null) lastPitch = pitch;
            if (roll !== null) lastRoll = roll;
            if (lastPitch !== null && lastRoll !== null) {
              let mode = document.getElementById('axisMode').value;
              let x = lastRoll, y = lastPitch;
              let pitchLabel = lastPitch, rollLabel = lastRoll;
              if (mode === 'swap') {
                x = lastPitch; y = lastRoll;
                pitchLabel = lastRoll; rollLabel = lastPitch;
              } else if (mode === 'invert') {
                x = -lastRoll; y = -lastPitch;
                pitchLabel = -lastPitch; rollLabel = -lastRoll;
              }
              let labelMode = document.getElementById('labelMode').value;
              let directionText = '';
              if (labelMode === 'lr_vh') {
                if (rollLabel > 2) directionText += 'Auto neigt nach rechts\n';
                else if (rollLabel < -2) directionText += 'Auto neigt nach links\n';
                else directionText += 'Auto steht gerade (links/rechts)\n';
                if (pitchLabel > 2) directionText += 'Auto neigt nach vorne';
                else if (pitchLabel < -2) directionText += 'Auto neigt nach hinten';
                else directionText += 'Auto steht gerade (vorne/hinten)';
                document.getElementById('tilt').textContent = directionText + `\nLinks/Rechts: ${Math.round(rollLabel)}°\nVorne/Hinten: ${Math.round(pitchLabel)}°`;
                // Tab2: Einzelanzeige
                document.getElementById('lr_val').textContent = `${Math.round(rollLabel)}°`;
                document.getElementById('vh_val').textContent = `${Math.round(pitchLabel)}°`;
                // Auto-Icons zeichnen
                drawCarLR(rollLabel);
                drawCarVH(pitchLabel);
                let lrDir = '';
                if (rollLabel > 2) lrDir = 'Auto neigt nach rechts';
                else if (rollLabel < -2) lrDir = 'Auto neigt nach links';
                else lrDir = 'Auto steht gerade';
                document.getElementById('tilt_lr').textContent = lrDir;
                let vhDir = '';
                    try {
                      const device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['2a24b789-7aab-4535-af3e-ee76a35cc42d'] }],
                        optionalServices: ['2a24b789-7aab-4535-af3e-ee76a35cc42d']
                      });
                      const server = await device.gatt.connect();
                      const service = await server.getPrimaryService('2a24b789-7aab-4535-af3e-ee76a35cc42d');
                      pitchChar = await service.getCharacteristic('cad48e28-7fbe-41cf-bae9-d77a6c233424');
                      rollChar  = await service.getCharacteristic('cad48e28-7fbe-41cf-bae9-d77a6c233425');
                      let lastPitch = null, lastRoll = null;
                      setInterval(async () => {
                        try {
                          const pitchVal = await pitchChar.readValue();
                          const rollVal  = await rollChar.readValue();
                          function decodeFloat(val) {
                            if (val.byteLength !== 4) return null;
                            let fLE = val.getFloat32(0, true);
                            let fBE = val.getFloat32(0, false);
                            if (!isNaN(fLE) && Math.abs(fLE) < 1000) return fLE;
                            if (!isNaN(fBE) && Math.abs(fBE) < 1000) return fBE;
                            return null;
                          }
                          let pitch = decodeFloat(pitchVal);
                          let roll  = decodeFloat(rollVal);
                          if (pitch !== null) lastPitch = pitch;
                          if (roll !== null) lastRoll = roll;
                          if (lastPitch !== null && lastRoll !== null) {
                            let mode = document.getElementById('axisMode').value;
                            let x = lastRoll, y = lastPitch;
                            let pitchLabel = lastPitch, rollLabel = lastRoll;
                            if (mode === 'swap') {
                              x = lastPitch; y = lastRoll;
                              pitchLabel = lastRoll; rollLabel = lastPitch;
                            } else if (mode === 'invert') {
                              x = -lastRoll; y = -lastPitch;
                              pitchLabel = -lastPitch; rollLabel = -lastRoll;
                            }
                            let labelMode = document.getElementById('labelMode').value;
                            let directionText = '';
                            if (labelMode === 'lr_vh') {
                              if (rollLabel > 2) directionText += 'Auto neigt nach rechts\n';
                              else if (rollLabel < -2) directionText += 'Auto neigt nach links\n';
                              else directionText += 'Auto steht gerade (links/rechts)\n';
                              if (pitchLabel > 2) directionText += 'Auto neigt nach vorne';
                              else if (pitchLabel < -2) directionText += 'Auto neigt nach hinten';
                              else directionText += 'Auto steht gerade (vorne/hinten)';
                              document.getElementById('tilt').textContent = directionText + `\nLinks/Rechts: ${Math.round(rollLabel)}°\nVorne/Hinten: ${Math.round(pitchLabel)}°`;
                              // Tab2: Einzelanzeige
                              document.getElementById('lr_val').textContent = `${Math.round(rollLabel)}°`;
                              document.getElementById('vh_val').textContent = `${Math.round(pitchLabel)}°`;
                              // Auto-Icons zeichnen
                              drawCarLR(rollLabel);
                              drawCarVH(pitchLabel);
                              let lrDir = '';
                              if (rollLabel > 2) lrDir = 'Auto neigt nach rechts';
                              else if (rollLabel < -2) lrDir = 'Auto neigt nach links';
                              else lrDir = 'Auto steht gerade';
                              document.getElementById('tilt_lr').textContent = lrDir;
                              let vhDir = '';
                              if (pitchLabel > 2) vhDir = 'Auto neigt nach vorne';
                              else if (pitchLabel < -2) vhDir = 'Auto neigt nach hinten';
                              else vhDir = 'Auto steht gerade';
                              document.getElementById('tilt_vh').textContent = vhDir;
                            } else {
                              document.getElementById('tilt').textContent =
                                `Pitch: ${Math.round(pitchLabel)}°\nRoll: ${Math.round(rollLabel)}°`;
                              document.getElementById('lr_val').textContent = `${Math.round(rollLabel)}°`;
                              document.getElementById('vh_val').textContent = `${Math.round(pitchLabel)}°`;
                              drawCarLR(rollLabel);
                              drawCarVH(pitchLabel);
                              document.getElementById('tilt_lr').textContent = '';
                              document.getElementById('tilt_vh').textContent = '';
                            }
                            drawLevel(x, y);
                            document.getElementById('output').textContent = '';
                          } else {
                            document.getElementById('tilt').textContent = 'Wert nicht verfügbar';
                            document.getElementById('output').textContent = '';
                          }
                        } catch (err) {
                          document.getElementById('output').textContent = 'Fehler beim Lesen: ' + err;
                        }
                      }, 1000);
                    } catch (error) {
                      document.getElementById('output').textContent = 'Fehler: ' + error;
                    }
    ctx.fillRect(-18,-13,8,6);
    ctx.fillRect(10,-13,8,6);
    ctx.fillRect(-18,7,8,6);
    ctx.fillRect(10,7,8,6);
    ctx.restore();
  }
  // Zeichnet ein Auto von der Seite, kippt je nach Vorne/Hinten-Neigung
  function drawCarVH(angle) {
    const canvas = document.getElementById('carVHimg');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(30,30);
    ctx.rotate(-angle * Math.PI / 180);
    const img = new Image();
    img.src = 'seitenansicht.png';
    img.onload = function() {
      ctx.drawImage(img, -25, -20, 50, 40);
      ctx.restore();
    };
  }
</script>
</body>
</html>
