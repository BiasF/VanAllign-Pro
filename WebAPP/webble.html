<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VanAlign Pro 1.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      text-align: center;
    }
    h1, h2 {
      margin-top: 1em;
    }
    #container {
      max-width: 400px;
      margin: 0 auto;
      padding: 1em;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .canvas-wrapper {
      width: 100%;
      max-width: 300px;
      height: auto;
      position: relative;
      margin-bottom: 2em;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #levelCanvas {
      width: 100%;
      height: auto;
      max-width: 300px;
      max-height: 300px;
      display: block;
      margin: 0 auto;
    }
    button {
      padding: 0.7em 1.5em;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      margin-bottom: 1em;
    }
    button.tabBtn {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #1976d2;
      margin-bottom: 0;
      margin-right: 0.5em;
      font-weight: bold;
      transition: background 0.2s, color 0.2s;
    }
    button.tabBtn.active {
      background: #1976d2;
      color: #fff;
    }
    button.tabBtn:hover {
      background: #bbdefb;
      color: #1976d2;
    }
    }
    @media (max-width: 500px) {
      #container {
        max-width: 98vw;
        padding: 0.5em;
      }
      #levelCanvas {
        max-width: 90vw;
        max-height: 90vw;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>VanAlign Pro 1.0</h1>
    <button id="connect">Mit VanAlign Pro Verbinden</button>
    <pre id="output"></pre>
    <div style="margin-bottom:1em;">
      <button id="tab1Btn" class="tabBtn" style="background:#1976d2;color:#fff;">Wasserwaage</button>
      <button id="tab2Btn" class="tabBtn">Neigung einzeln</button>
    </div>
    <div id="tab1">
      <h2>Ausrichtung</h2>
      <label for="axisMode" style="margin-bottom:0.5em;display:block;">Achsen-Modus:</label>
      <select id="axisMode" style="margin-bottom:0.5em;">
        <option value="normal">Standard</option>
        <option value="swap">Vorne/Hinten &lt;-&gt; Links/Rechts tauschen</option>
        <option value="invert">Achsen invertieren</option>
      </select>
      <label for="labelMode" style="margin-bottom:0.5em;display:block;">Beschriftung:</label>
      <select id="labelMode" style="margin-bottom:1em;">
        <option value="pitchroll">Pitch/Roll</option>
        <option value="lr_vh">Links/Rechts &amp; Vorne/Hinten</option>
      </select>
      <div id="tilt" style="font-size:1.2em; margin-bottom:1em;"></div>
      <div class="canvas-wrapper">
        <canvas id="levelCanvas" width="200" height="200" style="border:1px solid #ccc; background:#f8f8f8; border-radius:50%; display:block;"></canvas>
      </div>
    </div>
    <div id="tab2" style="display:none;">
      <h2>Neigung einzeln</h2>
      <div id="tilt_lr" style="font-size:1.2em; margin-bottom:1em;"></div>
      <div id="tilt_vh" style="font-size:1.2em; margin-bottom:1em;"></div>
      <div style="display:flex;justify-content:center;gap:2em;">
        <div style="background:#e3f2fd;padding:1em;border-radius:8px;min-width:120px;display:flex;flex-direction:column;align-items:center;">
          <h3>Links/Rechts</h3>
          <canvas id="carLR" width="60" height="60" style="margin-bottom:0.5em;"></canvas>
          <div id="lr_val" style="font-size:2em;"></div>
        </div>
        <div style="background:#e3f2fd;padding:1em;border-radius:8px;min-width:120px;display:flex;flex-direction:column;align-items:center;">
          <h3>Vorne/Hinten</h3>
          <canvas id="carVH" width="60" height="60" style="margin-bottom:0.5em;"></canvas>
          <div id="vh_val" style="font-size:2em;"></div>
        </div>
      </div>
    </div>
    </script>
   
  </div>
  <script>
    function drawLevel(x, y) {
      const canvas = document.getElementById('levelCanvas');
      // Responsive Canvas
      let size = Math.min(canvas.parentElement.offsetWidth, 300);
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Großer Kreis (Wasserwaage-Rahmen)
      ctx.beginPath();
      ctx.arc(size/2, size/2, size/2-10, 0, 2 * Math.PI);
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 4;
      ctx.stroke();
      // Skala
      ctx.font = `${Math.round(size/18)}px Arial`;
      ctx.fillStyle = '#333';
      ctx.fillText('-30°', 10, size/2);
      ctx.fillText('+30°', size-50, size/2);
      ctx.fillText('0°', size/2-10, size-10);
      // Kleiner Kreis (Mitte)
      ctx.beginPath();
      ctx.arc(size/2, size/2, size/20, 0, 2 * Math.PI);
      ctx.fillStyle = '#bbb';
      ctx.fill();
      ctx.strokeStyle = '#888';
      ctx.lineWidth = 2;
      ctx.stroke();
      // Bubble
      x = Math.max(-30, Math.min(30, x));
      y = Math.max(-30, Math.min(30, y));
      // Bubble-Position berechnen (x/y: -30 bis +30 mapped auf -(size/2-30) bis +(size/2-30))
      const bubbleX = size/2 + (x * (size/2-30) / 30);
      const bubbleY = size/2 + (y * (size/2-30) / 30);
      ctx.beginPath();
      ctx.arc(bubbleX, bubbleY, size/12, 0, 2 * Math.PI);
      ctx.fillStyle = '#4fc3f7';
      ctx.fill();
      ctx.strokeStyle = '#1976d2';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
    document.getElementById('connect').onclick = async () => {
      let pitchChar, rollChar;
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['2a24b789-7aab-4535-af3e-ee76a35cc42d'] }],
          optionalServices: ['2a24b789-7aab-4535-af3e-ee76a35cc42d']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('2a24b789-7aab-4535-af3e-ee76a35cc42d');
        pitchChar = await service.getCharacteristic('cad48e28-7fbe-41cf-bae9-d77a6c233424');
        rollChar  = await service.getCharacteristic('cad48e28-7fbe-41cf-bae9-d77a6c233425');
        let lastPitch = null, lastRoll = null;
        setInterval(async () => {
          try {
            const pitchVal = await pitchChar.readValue();
            const rollVal  = await rollChar.readValue();
            function decodeFloat(val) {
              if (val.byteLength !== 4) return null;
              let fLE = val.getFloat32(0, true);
              let fBE = val.getFloat32(0, false);
              if (!isNaN(fLE) && Math.abs(fLE) < 1000) return fLE;
              if (!isNaN(fBE) && Math.abs(fBE) < 1000) return fBE;
              return null;
            }
            let pitch = decodeFloat(pitchVal);
            let roll  = decodeFloat(rollVal);
            if (pitch !== null) lastPitch = pitch;
            if (roll !== null) lastRoll = roll;
            if (lastPitch !== null && lastRoll !== null) {
              let mode = document.getElementById('axisMode').value;
              let x = lastRoll, y = lastPitch;
              let pitchLabel = lastPitch, rollLabel = lastRoll;
              if (mode === 'swap') {
                x = lastPitch; y = lastRoll;
                pitchLabel = lastRoll; rollLabel = lastPitch;
              } else if (mode === 'invert') {
                x = -lastRoll; y = -lastPitch;
                pitchLabel = -lastPitch; rollLabel = -lastRoll;
              }
              let labelMode = document.getElementById('labelMode').value;
              let directionText = '';
              if (labelMode === 'lr_vh') {
                if (rollLabel > 2) directionText += 'Auto neigt nach rechts\n';
                else if (rollLabel < -2) directionText += 'Auto neigt nach links\n';
                else directionText += 'Auto steht gerade (links/rechts)\n';
                if (pitchLabel > 2) directionText += 'Auto neigt nach vorne';
                else if (pitchLabel < -2) directionText += 'Auto neigt nach hinten';
                else directionText += 'Auto steht gerade (vorne/hinten)';
                document.getElementById('tilt').textContent = directionText + `\nLinks/Rechts: ${Math.round(rollLabel)}°\nVorne/Hinten: ${Math.round(pitchLabel)}°`;
                // Tab2: Einzelanzeige
                document.getElementById('lr_val').textContent = `${Math.round(rollLabel)}°`;
                document.getElementById('vh_val').textContent = `${Math.round(pitchLabel)}°`;
                // Auto-Icons zeichnen
                drawCarLR(rollLabel);
                drawCarVH(pitchLabel);
                let lrDir = '';
                if (rollLabel > 2) lrDir = 'Auto neigt nach rechts';
                else if (rollLabel < -2) lrDir = 'Auto neigt nach links';
                else lrDir = 'Auto steht gerade';
                document.getElementById('tilt_lr').textContent = lrDir;
                let vhDir = '';
                if (pitchLabel > 2) vhDir = 'Auto neigt nach vorne';
                else if (pitchLabel < -2) vhDir = 'Auto neigt nach hinten';
                else vhDir = 'Auto steht gerade';
                document.getElementById('tilt_vh').textContent = vhDir;
              } else {
                document.getElementById('tilt').textContent =
                  `Pitch: ${Math.round(pitchLabel)}°\nRoll: ${Math.round(rollLabel)}°`;
                document.getElementById('lr_val').textContent = `${Math.round(rollLabel)}°`;
                document.getElementById('vh_val').textContent = `${Math.round(pitchLabel)}°`;
                drawCarLR(rollLabel);
                drawCarVH(pitchLabel);
                document.getElementById('tilt_lr').textContent = '';
                document.getElementById('tilt_vh').textContent = '';
    <script>
      // Zeichnet ein Auto von oben, rotiert je nach Links/Rechts-Neigung
      function drawCarLR(angle) {
        const canvas = document.getElementById('carLR');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(30,30);
        ctx.rotate(angle * Math.PI / 180);
        // Auto-Körper
        ctx.fillStyle = '#1976d2';
        ctx.fillRect(-20,-10,40,20);
        // Fenster
        ctx.fillStyle = '#90caf9';
        ctx.fillRect(-10,-7,20,14);
        // Räder
        ctx.fillStyle = '#333';
        ctx.fillRect(-18,-13,8,6);
        ctx.fillRect(10,-13,8,6);
        ctx.fillRect(-18,7,8,6);
        ctx.fillRect(10,7,8,6);
        ctx.restore();
      }
      // Zeichnet ein Auto von der Seite, kippt je nach Vorne/Hinten-Neigung
      function drawCarVH(angle) {
        const canvas = document.getElementById('carVH');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(30,40);
        ctx.rotate(-angle * Math.PI / 180);
        // Auto-Körper
        ctx.fillStyle = '#1976d2';
        ctx.fillRect(-20,-15,40,15);
        // Fenster
        ctx.fillStyle = '#90caf9';
        ctx.fillRect(-10,-13,20,8);
        // Räder
        ctx.fillStyle = '#333';
        ctx.beginPath(); ctx.arc(-12,0,5,0,2*Math.PI); ctx.fill();
        ctx.beginPath(); ctx.arc(12,0,5,0,2*Math.PI); ctx.fill();
        ctx.restore();
      }
    </script>
              }
              drawLevel(x, y);
              document.getElementById('output').textContent = '';
            } else {
              document.getElementById('tilt').textContent = 'Wert nicht verfügbar';
              document.getElementById('output').textContent = '';
            }
          } catch (err) {
            document.getElementById('output').textContent = 'Fehler beim Lesen: ' + err;
          }
        }, 1000);
      } catch (error) {
        document.getElementById('output').textContent = 'Fehler: ' + error;
      }
    };
  </script>
</body>
</html>
